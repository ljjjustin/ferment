# lib/cinder
#
# ``deploy.sh`` calls in this order:
#
# - install_cinder
# - configure_cinder
# - init_cinder
# - start_cinder
# - stop_cinder
# - cleanup_cinder

CINDER_DB_NAME=${CINDER_DB_NAME:-cinder}
CINDER_DB_USERNAME=${CINDER_DB_USERNAME:-cinder}
CINDER_DB_PASSWORD=${CINDER_DB_PASSWORD:-cinder}
CINDER_OS_TENANT_NAME=${CINDER_OS_TENANT_NAME:-openstack}
CINDER_OS_USERNAME=${CINDER_OS_USERNAME:-cinder}
CINDER_OS_PASSWORD=${CINDER_OS_PASSWORD:-admin}

install_cinder() {
    # install cinder related packages
    install_package openstack-cinder
}

configure_cinder() {
    # modify cinder config file
    cinder_conf='/etc/cinder/cinder.conf'
    if [ -f ${cinder_conf} ]; then
        iniset ${cinder_conf} DEFAULT connection mysql://${CINDER_DB_USERNAME}:${CINDER_DB_PASSWORD}@${MYSQL_HOST}/${CINDER_DB_NAME}
        iniset ${cinder_conf} DEFAULT auth_strategy keystone
    fi
    cinder_api_conf='/etc/cinder/api-paste.ini'
    if [ -f ${cinder_api_conf} ]; then
        iniset ${cinder_api_conf} filter:authtoken auth_protocol http
        iniset ${cinder_api_conf} filter:authtoken auth_host ${KEYSTONE_HOST}
        iniset ${cinder_api_conf} filter:authtoken auth_port 35357
        iniset ${cinder_api_conf} filter:authtoken admin_tenant_name ${CINDER_OS_TENANT_NAME}
        iniset ${cinder_api_conf} filter:authtoken admin_user ${CINDER_OS_USERNAME}
        iniset ${cinder_api_conf} filter:authtoken admin_password ${CINDER_OS_PASSWORD}
        iniset ${cinder_api_conf} filter:authtoken singing_dir /var/lib/cinder/keystone-singing-cinder
    fi
}

init_database() {
    local MYSQL="mysql -h${MYSQL_HOST}"
    ${MYSQL} -e "CREATE DATABASE IF NOT EXISTS ${CINDER_DB_NAME}"
    ${MYSQL} -e "GRANT ALL ON ${CINDER_DB_NAME}.* TO '${CINDER_DB_USERNAME}'@'${MYSQL_HOST}' IDENTIFIED BY '${CINDER_DB_PASSWORD}'"
    ${MYSQL} -e "FLUSH PRIVILEGES"
}

ensure_cinder_service_catalog() {
    local service_name='cinder'
    local service_type='volume'
    local service_desc='Cinder Volume Service'
    local public_url="http://${SERVICE_HOST}:8776/v1/\$(tenant_id)s"
    local admin_url="http://${SERVICE_HOST}:8776/v1/\$(tenant_id)s"
    local internal_url="http://${SERVICE_HOST}:8776/v1/\$(tenant_id)s"

    ensure_keystone_service "${service_name}" "${service_type}" "${service_desc}" "${public_url}" "${admin_url}" "${internal_url}"
    ensure_keystone_accounts "${CINDER_OS_TENANT_NAME}" "${CINDER_OS_USERNAME}" "${CINDER_OS_PASSWORD}" 'admin'
}

init_cinder() {
    chkconfig openstack-cinder-api on
    # handle database related config
    init_database
    cinder-manage db sync
    ensure_cinder_service_catalog
}

start_cinder() {
    # start cinder services
    /etc/init.d/openstack-cinder-api start
}

stop_cinder() {
    # stop cinder services
    /etc/init.d/openstack-cinder-api start
}

cleanup_cinder() {
    # clean up cinder packages
    remove_package openstack-cinder
}
