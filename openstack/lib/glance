# lib/glance
#
# ``deploy.sh`` calls in this order:
#
# - install_glance
# - configure_glance
# - init_glance
# - start_glance
# - stop_glance
# - cleanup_glance

GLANCE_DB_NAME=${GLANCE_DB_NAME:-glance}
GLANCE_DB_USERNAME=${GLANCE_DB_USERNAME:-glance}
GLANCE_DB_PASSWORD=${GLANCE_DB_PASSWORD:-glance}
GLANCE_OS_TENANT_NAME=${GLANCE_OS_TENANT_NAME:-openstack}
GLANCE_OS_USERNAME=${GLANCE_OS_USERNAME:-glance}
GLANCE_OS_PASSWORD=${GLANCE_OS_PASSWORD:-admin}

install_glance() {
    # install glance related packages
    echo "Installing glance ..."
    install_package openstack-glance
}

configure_glance() {
    # modify glance config file
    echo "Configuring glance ..."
    glance_reg_conf='/etc/glance/glance-registry.conf'
    if [ -f ${glance_reg_conf} ]; then
        iniset ${glance_reg_conf} DEFAULT sql_connection mysql://${GLANCE_DB_USERNAME}:${GLANCE_DB_PASSWORD}@${MYSQL_HOST}/${GLANCE_DB_NAME}
        iniset ${glance_reg_conf} paste_deploy flavor keystone
        iniset ${glance_reg_conf} keystone_authtoken auth_protocol http
        iniset ${glance_reg_conf} keystone_authtoken auth_host ${KEYSTONE_HOST}
        iniset ${glance_reg_conf} keystone_authtoken auth_port 35357
        iniset ${glance_reg_conf} keystone_authtoken admin_tenant_name ${GLANCE_OS_TENANT_NAME}
        iniset ${glance_reg_conf} keystone_authtoken admin_user ${GLANCE_OS_USERNAME}
        iniset ${glance_reg_conf} keystone_authtoken admin_password ${GLANCE_OS_PASSWORD}
        iniset ${glance_reg_conf} keystone_authtoken signing_dir /var/lib/glance/keystone-singing-glance
    fi
    glance_api_conf='/etc/glance/glance-api.conf'
    if [ -f ${glance_api_conf} ]; then
        iniset ${glance_api_conf} DEFAULT sql_connection mysql://${GLANCE_DB_USERNAME}:${GLANCE_DB_PASSWORD}@${MYSQL_HOST}/${GLANCE_DB_NAME}
        iniset ${glance_api_conf} DEFAULT workers 4
        iniset ${glance_api_conf} DEFAULT notifier_strategy noop
        iniset ${glance_api_conf} paste_deploy flavor keystone
        iniset ${glance_api_conf} keystone_authtoken auth_protocol http
        iniset ${glance_api_conf} keystone_authtoken auth_host ${KEYSTONE_HOST}
        iniset ${glance_api_conf} keystone_authtoken auth_port 35357
        iniset ${glance_api_conf} keystone_authtoken admin_tenant_name ${GLANCE_OS_TENANT_NAME}
        iniset ${glance_api_conf} keystone_authtoken admin_user ${GLANCE_OS_USERNAME}
        iniset ${glance_api_conf} keystone_authtoken admin_password ${GLANCE_OS_PASSWORD}
        iniset ${glance_api_conf} keystone_authtoken signing_dir /var/lib/glance/keystone-singing-glance
    fi
}

init_database() {
    local MYSQL="mysql -h${MYSQL_HOST}"
    ${MYSQL} -e "CREATE DATABASE IF NOT EXISTS ${GLANCE_DB_NAME}"
    ${MYSQL} -e "GRANT ALL ON ${GLANCE_DB_NAME}.* TO '${GLANCE_DB_USERNAME}'@'${MYSQL_HOST}' IDENTIFIED BY '${GLANCE_DB_PASSWORD}'"
    ${MYSQL} -e "FLUSH PRIVILEGES"
}

ensure_glance_service_catalog() {
    local service_name='glance'
    local service_type='image'
    local service_desc='Glance Image Service'
    local public_url="http://${SERVICE_HOST}:9292/v1"
    local admin_url="http://${SERVICE_HOST}:9292/v1"
    local internal_url="http://${SERVICE_HOST}:9292/v1"

    ensure_keystone_service "${service_name}" "${service_type}" "${service_desc}" "${public_url}" "${admin_url}" "${internal_url}"
    ensure_keystone_accounts "${GLANCE_OS_TENANT_NAME}" "${GLANCE_OS_USERNAME}" "${GLANCE_OS_PASSWORD}" 'admin'
}

init_glance() {
    echo "Initializing glance ..."
    chkconfig openstack-glance-registry on
    chkconfig openstack-glance-api on
    # handle database related config
    init_database
    glance-manage db_sync
    ensure_glance_service_catalog
}

start_glance() {
    # start glance services
    echo "Starting glance ..."
    /etc/init.d/openstack-glance-registry start
    /etc/init.d/openstack-glance-api start
}

stop_glance() {
    # stop glance services
    echo "Stopping glance ..."
    /etc/init.d/openstack-glance-api stop
    /etc/init.d/openstack-glance-registry stop
}

cleanup_glance() {
    # clean up glance packages
    echo "Cleaning up glance ..."
    remove_package openstack-glance
}
